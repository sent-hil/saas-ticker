<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Death of SaaS?</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='12' fill='%230d1117'/><polyline points='15,70 35,50 55,60 85,25' fill='none' stroke='%23f85149' stroke-width='7' stroke-linecap='round' stroke-linejoin='round'/><circle cx='85' cy='25' r='5' fill='%23f85149'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #0d1117;
      color: #c9d1d9;
      font-family: 'IBM Plex Mono', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
      padding: 24px 32px;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: sticky;
      top: 0;
      z-index: 100;
      background: #0d1117;
      padding: 16px 0 12px;
      margin: -16px 0 20px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #e6edf3;
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      font-size: 13px;
      color: #7d8590;
    }

    .last-updated {
      font-size: 11px;
      color: #484f58;
      white-space: nowrap;
      padding-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    colgroup col.col-rank    { width: 36px; }
    colgroup col.col-ticker  { width: 72px; }
    colgroup col.col-company { width: 160px; }
    colgroup col.col-close   { width: 100px; }
    colgroup col.col-mcap    { width: 100px; }
    colgroup col.col-nov1    { width: 155px; }
    colgroup col.col-ath     { width: 155px; }

    thead th {
      background: #161b22;
      color: #7d8590;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 10px 12px;
      border-bottom: 2px solid #30363d;
      position: sticky;
      top: 0;
      z-index: 10;
      user-select: none;
    }

    thead th.right {
      text-align: right;
    }

    /* Sortable column headers */
    thead th.sortable {
      cursor: pointer;
      transition: color 0.15s ease;
    }

    thead th.sortable:hover {
      color: #c9d1d9;
    }

    .sort-arrows {
      display: inline-flex;
      flex-direction: column;
      vertical-align: middle;
      margin-left: 4px;
      line-height: 1;
      gap: 1px;
    }

    .sort-arrows .arrow {
      font-size: 8px;
      line-height: 1;
      color: #30363d;
      transition: color 0.15s ease;
    }

    thead th.sort-asc .sort-arrows .arrow-up,
    thead th.sort-desc .sort-arrows .arrow-down {
      color: #e6edf3;
    }

    tbody tr {
      border-bottom: 1px solid #21262d;
      transition: background 0.1s ease;
    }

    tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.015);
    }

    tbody tr:hover {
      background: #1c2333;
    }

    td {
      padding: 7px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    td.rank {
      color: #484f58;
      font-size: 11px;
      text-align: center;
    }

    td.ticker {
      font-weight: 600;
    }

    td.ticker a {
      color: #58a6ff;
      text-decoration: none;
    }

    td.ticker a:hover {
      text-decoration: underline;
    }

    td.company {
      color: #8b949e;
    }

    td.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    td.pct {
      font-weight: 600;
      border-radius: 2px;
    }

    footer {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #21262d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    footer .meta {
      font-size: 11px;
      color: #484f58;
    }

    footer .refresh-btn {
      background: #21262d;
      color: #c9d1d9;
      border: 1px solid #30363d;
      padding: 6px 14px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    footer .refresh-btn:hover:not(:disabled) {
      background: #30363d;
    }

    footer .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #484f58;
      border-top-color: #c9d1d9;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Index badges in header */
    .header-indices {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .index-badge {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .index-badge .idx-label {
      font-size: 11px;
    }

    .index-badge .idx-value {
      font-size: 12px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Section headers with inline medians */
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 28px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #21262d;
    }

    .section-header:first-of-type {
      margin-top: 0;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #e6edf3;
      letter-spacing: -0.3px;
    }

    .section-count {
      font-size: 11px;
      color: #484f58;
    }

    .section-spacer {
      flex: 1;
    }

    .section-medians {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 11px;
    }

    .section-medians .med-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-medians .med-label {
      color: #484f58;
    }

    .section-medians .med-value {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      cursor: pointer;
      user-select: none;
      transition: opacity 0.15s ease;
    }

    .section-medians .med-value:hover {
      opacity: 0.85;
    }

    .section-medians .med-value .badge-arrow {
      font-size: 9px;
      margin-left: 3px;
      opacity: 0.5;
      display: inline-block;
      transition: transform 0.2s ease;
    }

    .section-medians .med-value.expanded .badge-arrow {
      transform: rotate(180deg);
    }

    /* Chart panels */
    .chart-panel {
      display: none;
      margin-bottom: 12px;
      border: 1px solid #30363d;
      border-radius: 6px;
      overflow: hidden;
    }

    .chart-panel.open {
      display: block;
      animation: chartSlideDown 0.2s ease-out;
    }

    @keyframes chartSlideDown {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 14px;
      border-bottom: 1px solid #21262d;
      font-size: 12px;
      color: #8b949e;
    }

    .chart-legend {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 10px;
      color: #7d8590;
    }

    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .chart-legend-swatch {
      width: 16px;
      height: 2px;
      border-radius: 1px;
    }

    .chart-legend-swatch.faint {
      height: 1px;
      opacity: 0.4;
    }

    .chart-legend-swatch.dashed {
      height: 0;
      border-top: 2px dashed;
    }

    .chart-close {
      background: none;
      border: none;
      color: #484f58;
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      transition: color 0.15s ease;
      font-family: inherit;
    }

    .chart-close:hover {
      color: #f85149;
    }

    .chart-body {
      padding: 16px;
      height: 300px;
      position: relative;
    }

    .chart-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #484f58;
      font-size: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #7d8590;
    }

    .empty-state p {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Death of SaaS?</h1>
        <p class="subtitle">Performance snapshot &mdash; Since Nov 3, 2025</p>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div class="header-indices">
          {% for idx in indices %}
          <div class="index-badge" style="color:{% if idx.pct is not none and idx.pct < 0 %}#f85149{% elif idx.pct is not none and idx.pct > 0 %}#7ee787{% else %}#c9d1d9{% endif %}">
            <span class="idx-label">{{ idx.label }}</span>
            <span class="idx-value">{{ idx.pct_fmt }}</span>
          </div>
          {% endfor %}
        </div>
        <span class="last-updated">Last updated: {{ last_updated }}</span>
      </div>
    </header>

    {% if rows or top_rows %}

    <!-- Chart panels (hidden by default, toggled by badge clicks) -->
    <div id="panel-nov3" class="chart-panel">
      <div class="chart-header">
        <span>% Since Nov 3, 2025</span>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <span class="chart-legend-swatch" style="background:#f85149"></span>
            <span>SaaS Median</span>
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-swatch dashed" style="border-color:#58a6ff"></span>
            <span>S&amp;P 500</span>
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-swatch dashed" style="border-color:#d2a8ff"></span>
            <span>Nasdaq</span>
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-swatch dashed" style="border-color:#7ee787"></span>
            <span>Dow</span>
          </div>
        </div>
        <button class="chart-close" onclick="toggleChart('nov3')">&times;</button>
      </div>
      <div class="chart-body">
        <canvas id="chart-nov3"></canvas>
        <div class="chart-loading" id="loading-nov3"><span class="spinner"></span> Loading chart&hellip;</div>
      </div>
    </div>

    <div id="panel-ath" class="chart-panel">
      <div class="chart-header">
        <span>Median % Since All-Time High</span>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <span class="chart-legend-swatch" style="background:#f0883e"></span>
            <span>Median</span>
          </div>
        </div>
        <button class="chart-close" onclick="toggleChart('ath')">&times;</button>
      </div>
      <div class="chart-body">
        <canvas id="chart-ath"></canvas>
        <div class="chart-loading" id="loading-ath"><span class="spinner"></span> Loading chart&hellip;</div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- TOP section -->
    <!-- ============================================================ -->
    {% if top_rows %}

    <!-- Top chart panels (hidden by default, toggled by badge clicks) -->
    <div id="panel-top-nov3" class="chart-panel">
      <div class="chart-header">
        <span>Top &mdash; % Since Nov 3, 2025</span>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <span class="chart-legend-swatch" style="background:#f85149"></span>
            <span>Top Median</span>
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-swatch dashed" style="border-color:#58a6ff"></span>
            <span>S&amp;P 500</span>
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-swatch dashed" style="border-color:#d2a8ff"></span>
            <span>Nasdaq</span>
          </div>
          <div class="chart-legend-item">
            <span class="chart-legend-swatch dashed" style="border-color:#7ee787"></span>
            <span>Dow</span>
          </div>
        </div>
        <button class="chart-close" onclick="toggleChart('top-nov3')">&times;</button>
      </div>
      <div class="chart-body">
        <canvas id="chart-top-nov3"></canvas>
        <div class="chart-loading" id="loading-top-nov3"><span class="spinner"></span> Loading chart&hellip;</div>
      </div>
    </div>

    <div id="panel-top-ath" class="chart-panel">
      <div class="chart-header">
        <span>Top &mdash; Median % Since All-Time High</span>
        <div class="chart-legend">
          <div class="chart-legend-item">
            <span class="chart-legend-swatch" style="background:#f0883e"></span>
            <span>Median</span>
          </div>
        </div>
        <button class="chart-close" onclick="toggleChart('top-ath')">&times;</button>
      </div>
      <div class="chart-body">
        <canvas id="chart-top-ath"></canvas>
        <div class="chart-loading" id="loading-top-ath"><span class="spinner"></span> Loading chart&hellip;</div>
      </div>
    </div>

    <div class="section-header">
      <span class="section-title">Top</span>
      <span class="section-count">{{ top_count }} companies</span>
      <span class="section-spacer"></span>
      <div class="section-medians">
        <div class="med-group">
          <span class="med-label">Median % Nov 3</span>
          <span class="med-value" id="badge-top-nov3" style="color:{% if top_med_nov1 is not none and top_med_nov1 < 0 %}#f85149{% elif top_med_nov1 is not none and top_med_nov1 > 0 %}#7ee787{% else %}#c9d1d9{% endif %}" onclick="toggleChart('top-nov3')">{{ top_med_nov1_fmt }}<span class="badge-arrow">&#9660;</span></span>
        </div>
        <div class="med-group">
          <span class="med-label">Median % ATH</span>
          <span class="med-value" id="badge-top-ath" style="color:{% if top_med_ath is not none and top_med_ath < 0 %}#f85149{% elif top_med_ath is not none and top_med_ath > 0 %}#7ee787{% else %}#c9d1d9{% endif %}" onclick="toggleChart('top-ath')">{{ top_med_ath_fmt }}<span class="badge-arrow">&#9660;</span></span>
        </div>
      </div>
    </div>

    <table class="dashboard-table">
      <colgroup>
        <col class="col-rank">
        <col class="col-ticker">
        <col class="col-company">
        <col class="col-close">
        <col class="col-mcap">
        <col class="col-nov1">
        <col class="col-ath">
      </colgroup>
      <thead>
        <tr>
          <th>#</th>
          <th class="sortable" data-sort="string" data-col="1">Ticker<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable" data-sort="string" data-col="2">Company<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right" data-sort="number" data-col="3">Last Close<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right" data-sort="number" data-col="4">Market Cap<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right sort-asc" data-sort="number" data-col="5">% Since Nov 3<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right" data-sort="number" data-col="6">% Since ATH<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
        </tr>
      </thead>
      <tbody>
        {% for row in top_rows %}
        <tr>
          <td class="rank">{{ loop.index }}</td>
          <td class="ticker"><a href="https://finance.yahoo.com/quote/{{ row.ticker }}" target="_blank">{{ row.ticker }}</a></td>
          <td class="company">{{ row.company }}</td>
          <td class="num" data-value="{{ row.close if row.close is not none else 0 }}">{{ row.close_fmt }}</td>
          <td class="num" data-value="{{ row.market_cap if row.market_cap is not none else 0 }}">{{ row.mcap_fmt }}</td>
          <td class="num pct" style="background:{{ row.pct_nov1_style.bg }};color:{{ row.pct_nov1_style.fg }}" data-value="{{ row.pct_nov1 if row.pct_nov1 is not none else -9999 }}" title="{{ row.ref_close_fmt }}">{{ row.pct_nov1_fmt }}</td>
          <td class="num pct" style="background:{{ row.pct_ath_style.bg }};color:{{ row.pct_ath_style.fg }}" data-value="{{ row.pct_ath if row.pct_ath is not none else -9999 }}" title="{{ row.ath_price_fmt }}">{{ row.pct_ath_fmt }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    <!-- ============================================================ -->
    <!-- SaaS section -->
    <!-- ============================================================ -->
    <div class="section-header">
      <span class="section-title">SaaS</span>
      <span class="section-count">{{ saas_count }} companies</span>
      <span class="section-spacer"></span>
      <div class="section-medians">
        <div class="med-group">
          <span class="med-label">Median % Nov 3</span>
          <span class="med-value" id="badge-nov3" style="color:{% if saas_med_nov1 is not none and saas_med_nov1 < 0 %}#f85149{% elif saas_med_nov1 is not none and saas_med_nov1 > 0 %}#7ee787{% else %}#c9d1d9{% endif %}" onclick="toggleChart('nov3')">{{ saas_med_nov1_fmt }}<span class="badge-arrow">&#9660;</span></span>
        </div>
        <div class="med-group">
          <span class="med-label">Median % ATH</span>
          <span class="med-value" id="badge-ath" style="color:{% if saas_med_ath is not none and saas_med_ath < 0 %}#f85149{% elif saas_med_ath is not none and saas_med_ath > 0 %}#7ee787{% else %}#c9d1d9{% endif %}" onclick="toggleChart('ath')">{{ saas_med_ath_fmt }}<span class="badge-arrow">&#9660;</span></span>
        </div>
      </div>
    </div>

    <table class="dashboard-table">
      <colgroup>
        <col class="col-rank">
        <col class="col-ticker">
        <col class="col-company">
        <col class="col-close">
        <col class="col-mcap">
        <col class="col-nov1">
        <col class="col-ath">
      </colgroup>
      <thead>
        <tr>
          <th>#</th>
          <th class="sortable" data-sort="string" data-col="1">Ticker<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable" data-sort="string" data-col="2">Company<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right" data-sort="number" data-col="3">Last Close<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right" data-sort="number" data-col="4">Market Cap<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right sort-asc" data-sort="number" data-col="5">% Since Nov 3<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
          <th class="sortable right" data-sort="number" data-col="6">% Since ATH<span class="sort-arrows"><span class="arrow arrow-up">&#9650;</span><span class="arrow arrow-down">&#9660;</span></span></th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td class="rank">{{ loop.index }}</td>
          <td class="ticker"><a href="https://finance.yahoo.com/quote/{{ row.ticker }}" target="_blank">{{ row.ticker }}</a></td>
          <td class="company">{{ row.company }}</td>
          <td class="num" data-value="{{ row.close if row.close is not none else 0 }}">{{ row.close_fmt }}</td>
          <td class="num" data-value="{{ row.market_cap if row.market_cap is not none else 0 }}">{{ row.mcap_fmt }}</td>
          <td class="num pct" style="background:{{ row.pct_nov1_style.bg }};color:{{ row.pct_nov1_style.fg }}" data-value="{{ row.pct_nov1 if row.pct_nov1 is not none else -9999 }}" title="{{ row.ref_close_fmt }}">{{ row.pct_nov1_fmt }}</td>
          <td class="num pct" style="background:{{ row.pct_ath_style.bg }};color:{{ row.pct_ath_style.fg }}" data-value="{{ row.pct_ath if row.pct_ath is not none else -9999 }}" title="{{ row.ath_price_fmt }}">{{ row.pct_ath_fmt }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <p>No price data yet. Click "Refresh Data" to fetch prices.</p>
    </div>
    {% endif %}

    <footer>
      <span class="meta">{{ top_count + saas_count }} companies ({{ top_count }} Top + {{ saas_count }} SaaS)</span>
      <form action="/fetch" method="post" style="margin:0">
        <button type="submit" class="refresh-btn">Refresh Data</button>
      </form>
    </footer>
  </div>

  <script>
    // -----------------------------------------------------------------------
    // Column sorting (works on all .dashboard-table tables)
    // -----------------------------------------------------------------------
    (function() {
      var tables = document.querySelectorAll('.dashboard-table');
      for (var t = 0; t < tables.length; t++) {
        (function(table) {
          var thead = table.querySelector('thead');
          var tbody = table.querySelector('tbody');
          if (!thead || !tbody) return;

          thead.addEventListener('click', function(e) {
            var th = e.target.closest('th.sortable');
            if (!th) return;

            var colIdx = parseInt(th.dataset.col, 10);
            var sortType = th.dataset.sort;
            var isAsc = th.classList.contains('sort-asc');
            var direction = isAsc ? 'desc' : 'asc';

            var allTh = thead.querySelectorAll('th.sortable');
            for (var i = 0; i < allTh.length; i++) {
              allTh[i].classList.remove('sort-asc', 'sort-desc');
            }
            th.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

            var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
            rows.sort(function(a, b) {
              var aCell = a.children[colIdx];
              var bCell = b.children[colIdx];
              var aVal, bVal;

              if (sortType === 'number') {
                aVal = parseFloat(aCell.dataset.value || aCell.textContent.replace(/[$,%+\s]/g, '')) || 0;
                bVal = parseFloat(bCell.dataset.value || bCell.textContent.replace(/[$,%+\s]/g, '')) || 0;
              } else {
                aVal = aCell.textContent.trim().toLowerCase();
                bVal = bCell.textContent.trim().toLowerCase();
              }

              if (aVal < bVal) return direction === 'asc' ? -1 : 1;
              if (aVal > bVal) return direction === 'asc' ? 1 : -1;
              return 0;
            });

            for (var j = 0; j < rows.length; j++) {
              rows[j].children[0].textContent = j + 1;
              tbody.appendChild(rows[j]);
            }
          });
        })(tables[t]);
      }
    })();

    // -----------------------------------------------------------------------
    // Refresh button with spinner + poll /status
    // -----------------------------------------------------------------------
    (function() {
      var isFetching = {{ 'true' if is_fetching else 'false' }};
      var form = document.querySelector('footer form');
      var btn = form ? form.querySelector('.refresh-btn') : null;
      if (!form || !btn) return;

      function setLoading(loading) {
        if (loading) {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span>Fetching\u2026';
          startPolling();
        } else {
          btn.disabled = false;
          btn.textContent = 'Refresh Data';
        }
      }

      var pollTimer = null;
      function startPolling() {
        if (pollTimer) return;
        pollTimer = setInterval(function() {
          fetch('/status').then(function(r) { return r.json(); }).then(function(data) {
            if (!data.is_fetching) {
              clearInterval(pollTimer);
              pollTimer = null;
              window.location.reload();
            }
          }).catch(function() {});
        }, 2000);
      }

      form.addEventListener('submit', function() {
        setLoading(true);
      });

      // On page load, if already fetching, show spinner and poll
      if (isFetching) {
        setLoading(true);
      }
    })();

    // -----------------------------------------------------------------------
    // Median chart with index benchmark hover highlighting
    // -----------------------------------------------------------------------
    (function() {
      var CHART_KEYS = ['nov3', 'ath', 'top-nov3', 'top-ath'];
      var charts = {};
      var chartData = {};
      var hoveredIndex = {};
      CHART_KEYS.forEach(function(k) { charts[k] = null; chartData[k] = null; hoveredIndex[k] = -1; });

      // Index line colors (full and faint variants)
      var INDEX_COLORS = { SPY: '#58a6ff', QQQ: '#d2a8ff', DIA: '#7ee787' };
      var INDEX_FAINT  = { SPY: 'rgba(88,166,255,0.2)', QQQ: 'rgba(210,168,255,0.2)', DIA: 'rgba(126,231,135,0.2)' };
      // Map dataset labels back to ticker keys for color lookup
      var LABEL_TO_TICKER = { 'S&P 500': 'SPY', 'Nasdaq': 'QQQ', 'Dow': 'DIA' };

      // Track which datasets are index lines per chart key
      var indexRanges = {};
      CHART_KEYS.forEach(function(k) { indexRanges[k] = {}; });

      // Format ISO date "2025-11-03" → "Nov 3"
      var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      function fmtDate(iso) {
        var parts = iso.split('-');
        return MONTHS[parseInt(parts[1], 10) - 1] + ' ' + parseInt(parts[2], 10);
      }

      function resetIndexStyles(chart, metric) {
        var r = indexRanges[metric];
        chart.data.datasets.forEach(function(ds, i) {
          if (i >= r.start && i < r.end) {
            var ticker = LABEL_TO_TICKER[ds.label];
            if (ticker) {
              ds.borderColor = INDEX_FAINT[ticker];
              ds.borderWidth = 1.5;
              ds.pointHoverRadius = 0;
            }
          }
        });
      }

      function highlightIndex(chart, metric, dsIdx) {
        var r = indexRanges[metric];
        chart.data.datasets.forEach(function(ds, i) {
          if (i >= r.start && i < r.end) {
            var ticker = LABEL_TO_TICKER[ds.label];
            if (!ticker) return;
            if (i === dsIdx) {
              ds.borderColor = INDEX_COLORS[ticker];
              ds.borderWidth = 2.5;
              ds.pointHoverRadius = 4;
            } else {
              ds.borderColor = INDEX_FAINT[ticker];
              ds.borderWidth = 1;
              ds.pointHoverRadius = 0;
            }
          }
        });
      }

      // Parse chart key into API params: "top-nov3" → { metric: "nov3", section: "top" }
      function parseChartKey(key) {
        if (key.indexOf('top-') === 0) {
          return { metric: key.slice(4), section: 'top' };
        }
        return { metric: key, section: 'saas' };
      }

      // Toggle chart panel open/closed
      window.toggleChart = function(key) {
        var panel = document.getElementById('panel-' + key);
        var badge = document.getElementById('badge-' + key);
        if (!panel || !badge) return;
        var isOpen = panel.classList.contains('open');

        if (isOpen) {
          panel.classList.remove('open');
          badge.classList.remove('expanded');
        } else {
          panel.classList.add('open');
          badge.classList.add('expanded');
          if (!charts[key]) {
            loadChart(key);
          }
        }
      };

      // Fetch data and render chart
      function loadChart(key) {
        var loading = document.getElementById('loading-' + key);
        var params = parseChartKey(key);
        fetch('/api/chart/median-history?metric=' + params.metric + '&section=' + params.section)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            chartData[key] = data;
            if (loading) loading.style.display = 'none';
            renderChart(key, data);
          })
          .catch(function(err) {
            if (loading) loading.textContent = 'Failed to load chart data';
            console.error('Chart load error:', err);
          });
      }

      function renderChart(key, data) {
        var params = parseChartKey(key);
        var metric = params.metric;
        var isTop = params.section === 'top';
        var ctx = document.getElementById('chart-' + key).getContext('2d');
        var medianColor = metric === 'nov3' ? '#f85149' : '#f0883e';
        var medianLabel = isTop
          ? (metric === 'nov3' ? 'Top Median' : 'Top Median (ATH)')
          : (metric === 'nov3' ? 'SaaS Median' : 'SaaS Median (ATH)');
        var labels = data.dates.map(fmtDate);
        var datasets = [];

        // 1. Index benchmark lines (faint by default, highlight on hover) — nov3 only
        var idxStart = 0;
        if (data.indices && metric === 'nov3') {
          var indexOrder = ['SPY', 'QQQ', 'DIA'];
          var indexLabels = { SPY: 'S&P 500', QQQ: 'Nasdaq', DIA: 'Dow' };
          indexOrder.forEach(function(t) {
            var info = data.indices[t];
            if (!info) return;
            datasets.push({
              label: indexLabels[t] || t,
              data: info.values,
              borderColor: INDEX_FAINT[t],
              borderWidth: 1.5,
              borderDash: [6, 4],
              pointRadius: 0,
              pointHoverRadius: 0,
              pointHoverBackgroundColor: INDEX_COLORS[t],
              tension: 0.3,
              fill: false
            });
          });
        }
        var idxEnd = datasets.length;
        indexRanges[key] = { start: idxStart, end: idxEnd };

        // 2. Median line (solid, prominent, always visible)
        var medianIdx = datasets.length;
        datasets.push({
          label: medianLabel,
          data: data.median,
          borderColor: medianColor,
          borderWidth: 2.5,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: medianColor,
          tension: 0.3,
          fill: false
        });

        charts[key] = new Chart(ctx, {
          type: 'line',
          data: { labels: labels, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            hover: { mode: 'nearest', intersect: false, axis: 'xy' },
            onHover: function(event, activeElements, chart) {
              var r = indexRanges[key];
              var canvas = chart.canvas;
              if (!activeElements || activeElements.length === 0) {
                if (hoveredIndex[key] !== -1) {
                  hoveredIndex[key] = -1;
                  resetIndexStyles(chart, key);
                  chart.update('none');
                  canvas.style.cursor = 'default';
                }
                return;
              }
              // Find nearest index line
              var nearest = null;
              for (var i = 0; i < activeElements.length; i++) {
                var di = activeElements[i].datasetIndex;
                if (di >= r.start && di < r.end) {
                  nearest = activeElements[i];
                  break;
                }
              }
              if (!nearest) {
                if (hoveredIndex[key] !== -1) {
                  hoveredIndex[key] = -1;
                  resetIndexStyles(chart, key);
                  chart.update('none');
                  canvas.style.cursor = 'default';
                }
                return;
              }
              var dsIdx = nearest.datasetIndex;
              if (hoveredIndex[key] === dsIdx) return;
              hoveredIndex[key] = dsIdx;
              highlightIndex(chart, key, dsIdx);
              chart.update('none');
              canvas.style.cursor = 'pointer';
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#161b22',
                titleColor: '#c9d1d9',
                bodyColor: '#c9d1d9',
                borderColor: '#30363d',
                borderWidth: 1,
                displayColors: true,
                filter: function(tooltipItem) {
                  var di = tooltipItem.datasetIndex;
                  // Always show median
                  if (di === medianIdx) return true;
                  // Show hovered index line only
                  return di === hoveredIndex[key];
                },
                callbacks: {
                  label: function(ctx) {
                    var name = ctx.dataset.label;
                    var val = ctx.parsed.y != null ? ctx.parsed.y.toFixed(1) + '%' : 'N/A';
                    return name + ': ' + val;
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  color: '#8b949e',
                  maxTicksLimit: 12,
                  maxRotation: 0,
                  font: { family: "'IBM Plex Mono', monospace", size: 10 }
                },
                grid: { color: '#21262d' }
              },
              y: {
                ticks: {
                  color: '#8b949e',
                  callback: function(val) { return val.toFixed(0) + '%'; },
                  font: { family: "'IBM Plex Mono', monospace", size: 10 }
                },
                grid: { color: '#21262d' }
              }
            }
          }
        });

        // Reset index highlights on mouse leave
        charts[key].canvas.addEventListener('mouseleave', function() {
          if (hoveredIndex[key] !== -1) {
            hoveredIndex[key] = -1;
            resetIndexStyles(charts[key], key);
            charts[key].update('none');
          }
        });
      }
    })();
  </script>
</body>
</html>
